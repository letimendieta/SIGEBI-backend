CREATE OR REPLACE FUNCTION public.suma_beneficiarios(mes integer, anho integer)
 RETURNS TABLE(coddescripcion character varying, femenino bigint, masculino bigint, suma numeric)
 LANGUAGE plpgsql
AS $function$
declare
    f record;
begin
 for f in select estamento_id from estamentos
    loop 
      return query
	SELECT
		(select descripcion from estamentos where estamento_id=f.estamento_id) as coddescripcion,
	    o.femenino, o.masculino, SUM(o.femenino + o.masculino) AS Suma
	FROM(
		select count(per.sexo) as femenino,
		(select count(per.sexo) 
			from consultas c
			join pacientes p on c.paciente_id=p.paciente_id
			join personas per on p.persona_id=per.persona_id 
			left join estamentos es on per.estamento_id = es.estamento_id
			where EXTRACT(MONTH FROM fecha)=mes 
			and EXTRACT(YEAR FROM fecha)=anho 
			and per.sexo like '%M%' and es.estamento_id=f.estamento_id) as masculino
		from consultas c
		join pacientes p on  c.paciente_id=p.paciente_id
		join personas per on p.persona_id=per.persona_id 
		left join carreras cr on per.carrera_id=cr.carrera_id
		left join estamentos es on per.estamento_id = es.estamento_id
		where EXTRACT(MONTH FROM fecha)=mes and EXTRACT(YEAR FROM fecha)=anho 
		and per.sexo like '%F%' and es.estamento_id=f.estamento_id
	) AS o
	GROUP BY 
		 o.femenino, 
		 o.masculino;
	end loop;
END;
$function$
;

