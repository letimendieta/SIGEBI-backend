CREATE OR REPLACE FUNCTION public.suma_dependencia(mes integer, anho integer)
 RETURNS TABLE(nombreestamento character varying, coddependencia character varying, femenino bigint, masculino bigint, suma numeric)
 LANGUAGE plpgsql
AS $function$
declare
    f record;
begin
    for f in select dependencia_id from dependencias LIMIT 3
    loop 
        
      return query
		 SELECT
	(select descripcion from estamentos where codigo='FUN') as nombreestamento,
	(select descripcion from dependencias where dependencia_id=f.dependencia_id) as coddependencia,
	       o.femenino, 
	       o.masculino, 
	       SUM(o.femenino + o.masculino) AS Suma
	FROM(
	select count(per.sexo) as femenino,
	(select count(per.sexo) from consultas c
	join pacientes p
	on  c.paciente_id=p.paciente_id
	join personas per
	on p.persona_id=per.persona_id 
	join dependencias dc
	on per.dependencia_id=dc.dependencia_id
	join estamentos es
	on per.estamento_id = es.estamento_id
	where EXTRACT(MONTH FROM fecha)=mes and EXTRACT(YEAR FROM fecha)=anho and per.sexo like '%M%' and es.codigo='FUN' and dc.dependencia_id=f.dependencia_id) as masculino
	from consultas c
	join pacientes p
	on  c.paciente_id=p.paciente_id
	join personas per
	on p.persona_id=per.persona_id 
	join dependencias dc
	on per.dependencia_id=dc.dependencia_id
	join estamentos es
	on per.estamento_id = es.estamento_id
	where EXTRACT(MONTH FROM fecha)=mes and EXTRACT(YEAR FROM fecha)=anho and per.sexo like '%F%' and es.codigo='FUN'  and dc.dependencia_id=f.dependencia_id
	)
	AS o
	GROUP BY 
		 o.femenino, 
		 o.masculino;
		 
    end loop;
END;
$function$
;

