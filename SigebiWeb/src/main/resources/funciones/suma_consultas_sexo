CREATE OR REPLACE FUNCTION public.suma_consultas_sexo(mes integer, anho integer, areaid integer)
 RETURNS TABLE(femenino bigint, masculino bigint, suma numeric)
 LANGUAGE plpgsql
AS $function$
	BEGIN
		return query
		select
 o.femenino, o.masculino,
 SUM(o.femenino + o.masculino) AS suma
FROM(
	-------------------conteo consultas----------------
	select count(per.sexo) as femenino,
	(select count(per.sexo)
	from consultas c
		join pacientes p
		on  c.paciente_id=p.paciente_id
		join personas per
		on p.persona_id=per.persona_id 
		left join carreras cr
		on per.carrera_id=cr.carrera_id
		left join estamentos es
		on per.estamento_id = es.estamento_id
		where EXTRACT(MONTH FROM fecha)=mes and EXTRACT(YEAR FROM fecha)=anho 
		and per.sexo like '%M%' and (es.codigo='EST' or es.codigo='FUN' or es.codigo='DOC')
		and C.area_id  = areaid
		) as masculino
	from consultas c
	join pacientes p on  c.paciente_id=p.paciente_id
	join personas per on p.persona_id=per.persona_id 
	left join carreras cr on per.carrera_id=cr.carrera_id
	left join estamentos es	on per.estamento_id = es.estamento_id
	where EXTRACT(MONTH FROM fecha)=mes and EXTRACT(YEAR FROM fecha)=anho 
	and per.sexo like '%F%' and (es.codigo='EST' or es.codigo='FUN' or es.codigo='DOC')
	and c.area_id  = areaid
	)AS o
	GROUP BY 
		 o.femenino, 
		 o.masculino;
	END;
$function$
;

