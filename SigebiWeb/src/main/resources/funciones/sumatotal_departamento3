CREATE OR REPLACE FUNCTION public.sumatotal_departamento3(mes integer, anho integer, areaid integer)
 RETURNS TABLE(total bigint, codcarrera character varying)
 LANGUAGE plpgsql
AS $function$
declare
    f record;
begin
    for f in select departamento_id from departamentos
    loop 
   
      return query
		 select count(*) as total,
		(select codigo from departamentos 
			where departamento_id=f.departamento_id) as coddepartamento
		from procedimientos pr
		join pacientes p on  pr.paciente_id=p.paciente_id
		join personas per on p.persona_id=per.persona_id 
		left join departamentos dp on per.departamento_id=dp.departamento_id
		left join estamentos es	on per.estamento_id = es.estamento_id
		where EXTRACT(MONTH FROM fecha)=mes 
		and EXTRACT(YEAR FROM fecha)=anho 
		and es.codigo like '%DOC%' 
		and dp.departamento_id=f.departamento_id
		and pr.area_id  = areaid
		and pr.estado = 'FINALIZADO';
		 
    end loop;
END;
$function$
;

